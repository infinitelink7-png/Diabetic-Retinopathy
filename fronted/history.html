<!DOCTYPE html>
<head>
    <title>Assessment History</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f6f8fb; padding:20px; }
        .card { background:#fff; max-width:1000px; margin:auto; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size:22px; margin-bottom:10px; }
        .btn { padding:10px 14px; background:#4f46e5; color:#fff; border:none; border-radius:6px; cursor:pointer; text-decoration: none; display: inline-block; }
        .btn:hover { background:#4338ca; }
        .assessment-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .risk-high { color: #dc2626; font-weight: bold; }
        .risk-moderate { color: #ea580c; font-weight: bold; }
        .risk-low { color: #16a34a; font-weight: bold; }
        .date { color: #666; font-size: 14px; }
        .loading { text-align: center; padding: 20px; }
        .empty-state { text-align: center; padding: 40px; color: #666; }
        .session-info { background: #f0f9ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>üìã Your Assessment History</h1>
            <a href="step1.html" class="btn">New Assessment</a>
        </div>
        
        <div id="session-info" class="session-info">
            Loading your session...
        </div>
        
        <div id="assessments-list">
            <div class="loading">Loading your assessments...</div>
        </div>
    </div>

    <script>
        let assessments = [];

        async function loadAssessments() {
            const sessionId = localStorage.getItem('session_id');
            
            if (!sessionId) {
                document.getElementById('assessments-list').innerHTML = `
                    <div class="empty-state">
                        <h3>No assessment history found</h3>
                        <p>Complete your first risk assessment to see your history here.</p>
                        <a href="step1.html" class="btn">Start Your First Assessment</a>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/assessments/${sessionId}`);
                const data = await response.json();

                if (data.success) {
                    assessments = data.assessments;
                    displayAssessments();
                    updateSessionInfo();
                } else {
                    document.getElementById('assessments-list').innerHTML = 
                        '<div class="empty-state">Error loading assessments: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                document.getElementById('assessments-list').innerHTML = 
                    '<div class="empty-state">Connection error. Please check if the server is running.</div>';
            }
        }

        function displayAssessments() {
            const container = document.getElementById('assessments-list');
            
            if (assessments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No assessments yet</h3>
                        <p>Complete your first risk assessment to see your history here.</p>
                        <a href="step1.html" class="btn">Start Assessment</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = assessments.map(assessment => `
                <div class="assessment-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <span class="risk-${assessment.risk_level.toLowerCase().replace(' ', '-')}">
                                ${assessment.risk_level} (${assessment.risk_score}/100)
                            </span>
                            <div class="date">${new Date(assessment.created_at).toLocaleDateString()} at ${new Date(assessment.created_at).toLocaleTimeString()}</div>
                        </div>
                        <button onclick="viewAssessmentDetails('${assessment.id}')" class="btn">View Details</button>
                    </div>
                    
                    <div style="font-size: 14px; color: #666;">
                        <strong>Key Factors:</strong>
                        ${assessment.explanation.slice(0, 2).map(factor => 
                            `${factor.description}`
                        ).join(', ')}
                    </div>
                </div>
            `).join('');
        }

        function updateSessionInfo() {
            const sessionId = localStorage.getItem('session_id');
            document.getElementById('session-info').innerHTML = `
                <strong>Your Session</strong><br>
                You have completed <strong>${assessments.length}</strong> risk assessment${assessments.length !== 1 ? 's' : ''} in this browser session.
                <small style="color: #666; display: block; margin-top: 5px;">
                    Session ID: ${sessionId}
                </small>
            `;
        }

        function viewAssessmentDetails(assessmentId) {
            // Âú®Êñ∞Á™óÂè£ÊàñÊ†áÁ≠æÈ°µ‰∏≠ÊòæÁ§∫ËØ¶ÁªÜÁªìÊûú
            const details = assessments.find(a => a.id === assessmentId);
            if (details) {
                const resultWindow = window.open('', '_blank');
                resultWindow.document.write(`
                    <html>
                    <head><title>Assessment Details</title></head>
                    <body style="font-family: Arial; padding: 20px;">
                        <h1>Assessment Details</h1>
                        <div style="background:#f0f9ff; padding:15px; border-radius:8px;">
                            <h3>Risk Assessment Results</h3>
                            <div><strong>Risk Level:</strong> ${details.risk_level}</div>
                            <div><strong>Risk Score:</strong> ${details.risk_score}/100</div>
                            <div><strong>Date:</strong> ${new Date(details.created_at).toLocaleString()}</div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>Key Factors:</h4>
                            <ul>
                                ${details.explanation.map(factor => 
                                    `<li>${factor.description} (${factor.impact} impact)</li>`
                                ).join('')}
                            </ul>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>Recommendations:</h4>
                            <ul>
                                ${details.recommendations.map(rec => 
                                    `<li><strong>${rec.title}:</strong> ${rec.message}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        
                        <button onclick="window.print()" style="margin-top: 20px; padding: 10px;">Print Results</button>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px; margin-left: 10px;">Close</button>
                    </body>
                    </html>
                `);
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñËØÑ‰º∞ÂéÜÂè≤
        window.addEventListener('DOMContentLoaded', loadAssessments);
    </script>
</body>
</html>