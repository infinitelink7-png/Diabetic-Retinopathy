<!doctype html>
<head>
  <title>Retinopathy Diabetics Risk Assessment</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f8fb; padding:20px; }
    .card { background:#fff; max-width:900px; margin:auto; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    h1 { font-size:22px; margin-bottom:10px; }
    h2 { font-size:18px; margin-top:20px; }
    label { display:block; margin-top:12px; font-size:14px; }
    input[type="checkbox"] { width:auto; margin-right:6px; }
    button { margin-top:16px; padding:10px 14px; background:#4f46e5; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#4338ca; }
    .review-box { background:#f9fafb; padding:10px; border-radius:6px; font-size:14px; line-height:1.5; }
    .result-box {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

   .risk-high { color: #dc2626; font-weight: bold; }
   .risk-moderate { color: #ea580c; font-weight: bold; }
   .risk-low { color: #16a34a; font-weight: bold; }

  .recommendation-item {
   background: white;
   border-left: 4px solid #4f46e5;
   padding: 12px;
   margin: 8px 0;
   border-radius: 4px;
}
  </style>
</head>
<body>
<div class="card">
  <h1>Retinopathy Diabetics Risk Assessment</h1>
  <h2>Step 5: Review & Consent</h2>
  <p style="font-size:14px; color:#555;">
    This is the final step of the Diabetic Retinopathy Risk Assessment.  
    Please carefully review all your previous responses from Steps 1‚Äì4.  
    Once you confirm the information is correct, kindly provide your consent for data use and submit for AI-based analysis.
  </p>
  
  <form id="drForm" onsubmit="return false;">
    
    <!--Review section-->
    <h2>Review Your Information</h2>
    <div id="reviewBox" class="review-box"></div>
    
    <!--Privacy & consent-->
    <p style="margin-top:10px;font-size:13px;">
      <b>Privacy Statement:</b> Your health data is encrypted and anonymized for analysis. We adhere to strict data protection regulations like HIPAA/GDPR. This data will only be used to generate your risk assessment and, with your consent, to improve our AI model.
    </p>

    <label>
      <input type="checkbox" id="consent"> I have reviewed my information and agree to the terms of use and privacy policy.
    </label>

    <!--Navigation buttons-->
    <div class="row">
      <button type="button" onclick="location.href='step4.html'">Previous</button>
      <button type="button" onclick="submitForm()">Submit for Analysis</button>
    </div>
    
  </form>

  <!--Submission result display-->
  <div id="result" style="margin-top:15px;"></div>
</div>

<script>
  //Retrieve all previos step data
function gatherAllData() {
  const data = {};
  ["step1","step2","step3","step4"].forEach(step => {
    Object.assign(data, JSON.parse(localStorage.getItem(step) || "{}"));
  });
  return data;
}

//Fill the review box with all user data
function fillReview() {
  const step1 = JSON.parse(localStorage.getItem("step1") || "{}");
  const step2 = JSON.parse(localStorage.getItem("step2") || "{}");
  const step3 = JSON.parse(localStorage.getItem("step3") || "{}");
  const step4 = JSON.parse(localStorage.getItem("step4") || "{}");

  let txt = "";

  txt += "<u>Step 1: Diabetes Basics</u><br>";
  txt += "Age: " + (step1.age || "-") + "<br>";
  txt += "Diabetes Type: " + (step1.diabetes_type || "-") + "<br>";
  txt += "Duration: " + (step1.duration || "-") + " years<br>";
  txt += "HbA1c: " + (step1.hba1c || "-") + "<br>";
  txt += "Diabetes Management: " + ((step1.t_insulin?"Insulin ":"") +
                                    (step1.t_oral?"Oral ":"") +
                                    (step1.t_diet?"Diet ":"") +
                                    (step1.t_none?"None ":"") || "-") + "<br>";
  txt += "Blood Sugar Check Frequency: " + (step1.sugar_check || "-") + "<br><br>";

  txt += "<u>Step 2: Diabetes-Related Health</u><br>";
  txt += "Hypertension: " + (step2.hypertension || "-") + "<br>";
  if(step2.hypertension === "Yes"){
    txt += "BP Systolic/Diastolic: " + (step2.bp_sys || "-") + "/" + (step2.bp_dia || "-") + " mmHg<br>";
  }
  txt += "Nephropathy: " + (step2.nephropathy || "-") + "<br>";
  txt += "Neuropathy: " + (step2.neuropathy || "-") + "<br>";
  txt += "High Cholesterol: " + (step2.cholesterol || "-") + "<br><br>";

  txt += "<u>Step 3: Lifestyle & Body Metrics</u><br>";
txt += "Smoking Status: " + (step3.smoking || "-") + "<br>";

if(step3.unit === "metric"){
  txt += "Height: " + (step3.height_cm || "-") + " cm<br>";
  txt += "Weight: " + (step3.weight_kg || "-") + " kg<br>";
} else if(step3.unit === "imperial"){
  txt += "Height: " + (step3.height_ft || "-") + " ft " + (step3.height_in || "-") + " in<br>";
  txt += "Weight: " + (step3.weight_lbs || "-") + " lbs<br>";
}

txt += "BMI: " + (step3.bmi || "-") + " (" + (step3.bmi_category || "-") + ")<br><br>";


  txt += "<u>Step 4: Eye Health & Medication Habits</u><br>";
  txt += "Last Dilated Eye Exam: " + (step4.eye_exam || "-") + "<br>";
  txt += "Diagnosed with Diabetic Retinopathy: " + (step4.dr_diag || "-") + "<br>";
  txt += "Vision Problems: " + (step4.vision_problems ? step4.vision_problems.join(", ") : "-") + "<br>";
  txt += "Medication Adherence: " + (step4.adherence || "-") + "<br>";

  document.getElementById("reviewBox").innerHTML = txt;
}


//Form submission & API call
function submitForm() {
  if(!document.getElementById("consent").checked){
    alert("Please agree to the terms before submitting.");
    return;
  }

  // Gather all data
  const userData = gatherAllData();
  
  // ÁîüÊàêÊàñËé∑Âèñ‰ºöËØùID
  let sessionId = localStorage.getItem('session_id');
  if (!sessionId) {
    sessionId = generateSessionId();
    localStorage.setItem('session_id', sessionId);
  }
  userData.session_id = sessionId;
  
  // Show loading message
  document.getElementById("result").innerHTML = "<b>Analyzing your data... Please wait.</b>";

  // Send data to backend API
  fetch('http://localhost:5000/api/predict', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(userData)
  })
  .then(response => response.json())
  .then(data => {
    if(data.success) {
      // Display results
      displayResults(data);
      
      // ÊòæÁ§∫Êü•ÁúãÂéÜÂè≤ËÆ∞ÂΩïÁöÑÈìæÊé•
      document.getElementById("result").innerHTML += `
        <div style="margin-top: 15px; text-align: center;">
          <a href="history.html" style="color: #4f46e5; text-decoration: none;">
            üìã View Your Assessment History
          </a>
        </div>
      `;
    } else {
      document.getElementById("result").innerHTML = 
        "<b>Error:</b> " + (data.error || "Analysis failed. Please try again.");
    }
  })
  .catch(error => {
    document.getElementById("result").innerHTML = 
      "<b>Connection Error:</b> Cannot connect to analysis service. Make sure the backend server is running.";
    console.error('Error:', error);
  });
}

// ÁîüÊàê‰ºöËØùID
function generateSessionId() {
  return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

fillReview();
</script>
</body>
</html>
